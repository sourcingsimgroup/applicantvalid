<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Applicant Valid + Dashboard</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700;800&display=swap" rel="stylesheet">

<style>
:root{
  --brand:#3F704D; --bg:#fff; --ink:#212121; --muted:#f3f4f6; --line:#e5e7eb; --danger:#d72638; --gray:#9ca3af;
  --head-bg:#556B2F; --head-fg:#e1e8e5; --name-col-w:260px; --male:#5DADEC; --female:#FF8FB1; --stickyOffset:64px;
}
*{box-sizing:border-box}
html,body{width:100%;max-width:100%;overflow-x:hidden}
body{margin:0;font-family:Montserrat,system-ui,Arial,sans-serif;color:var(--ink);background:var(--bg)}
.loading-screen{position:fixed;inset:0;z-index:9999;background:#556B2F;display:flex;align-items:center;justify-content:center;flex-direction:column;gap:16px;padding:24px}
.loading-logo{color:#E6EDF3;letter-spacing:.15em;text-transform:uppercase;font-weight:800;font-size:clamp(26px,5vw,42px);animation:blink 1.1s ease-in-out infinite}
.loading-sub{color:#E6EDF3;font-size:14px;opacity:.9;text-align:center;max-width:640px}
.loading-bar{width:min(220px,60vw);height:4px;background:rgba(255,255,255,.16);border-radius:9999px;overflow:hidden;position:relative;box-shadow:0 0 0 1px rgba(255,255,255,.06) inset}
.loading-bar::before{content:"";position:absolute;inset:0;width:40%;height:100%;background:linear-gradient(90deg,#fff,#cfd8e3);border-radius:inherit;animation:load 1.2s cubic-bezier(.4,0,.2,1) infinite}
@keyframes blink{0%,100%{opacity:1}50%{opacity:.25}}
@keyframes load{0%{transform:translateX(-100%)}50%{transform:translateX(30%)}100%{transform:translateX(200%)}}
@media (prefers-reduced-motion:reduce){.loading-logo{animation:none}.loading-bar::before{animation:none;width:100%}}
.app{opacity:0;transform:translateY(8px);transition:opacity .35s ease,transform .35s ease}
body.ready .app{opacity:1;transform:none}
.header{background:var(--head-bg);color:var(--head-fg);padding:10px 16px;position:sticky;top:0;z-index:100;box-shadow:0 2px 6px rgba(0,0,0,.08)}
.header-inner{display:flex;align-items:center;gap:16px;justify-content:space-between;flex-wrap:wrap}
.title{margin:0;font-weight:800;font-size:clamp(18px,2.2vw,28px);color:var(--head-fg)}
.subtitle{margin:2px 0 0;font-size:11px;opacity:.9;letter-spacing:.02em;color:var(--head-fg)}
.userbox{display:none;align-items:center;gap:8px}
.userbox .uname{font-size:12px;background:#111827;color:#e5e7eb;padding:6px 10px;border-radius:9999px}
.header .btn-ghost{background:transparent;border:1px solid rgba(255,255,255,.75);color:#fff;border-radius:10px;padding:8px 12px;font-weight:700;text-decoration:none}
.header .btn-ghost[aria-current="page"]{background:rgba(255,255,255,.12)}
.header .btn-ghost:hover{border-color:#fff}
.layout{display:grid;grid-template-columns:220px 1fr;gap:16px;padding:16px;align-items:start}
.content{min-width:0}
.sidebar{position:sticky;top:calc(var(--stickyOffset) + 10px);align-self:start;background:var(--muted);border-radius:14px;box-shadow:0 2px 10px rgba(0,0,0,.06);overflow:hidden}
.sidebar-head{background:var(--head-bg);color:var(--head-fg);padding:12px 14px;font-weight:700}
.sidebar-body{padding:12px}
.filter-toggle{display:none;align-items:center;gap:10px;width:fit-content;margin:12px 12px 8px 12px;padding:10px 14px;background:var(--brand);color:#fff;border:none;border-radius:14px;font-weight:700;cursor:pointer;box-shadow:0 2px 6px rgba(0,0,0,.12)}
.filter-toggle .bars{position:relative;width:18px;height:12px}
.filter-toggle .bars::before,.filter-toggle .bars::after,.filter-toggle .bars>span{content:"";position:absolute;left:0;right:0;height:2px;background:#fff;border-radius:2px}
.filter-toggle .bars::before{top:0}.filter-toggle .bars>span{top:5px}.filter-toggle .bars::after{bottom:0}
.filters{display:grid;grid-template-columns:1fr;gap:10px}
.capsule{width:100%;background:#f1f3f5;color:var(--ink);border:1px solid var(--line);border-radius:12px;min-height:48px;position:relative;box-shadow:0 1px 2px rgba(0,0,0,.04);padding:6px 34px 6px 12px;cursor:pointer}
.capsule label{position:absolute;left:12px;right:34px;top:6px;margin:0;font-size:11px;font-weight:800;letter-spacing:.02em;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;color:#475569;pointer-events:none}
.capsule .cap-value{position:absolute;left:12px;right:34px;bottom:6px;color:var(--brand);font-weight:400;font-size:12px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;pointer-events:none}
.capsule .cap-value:empty{display:none}
.capsule select{position:absolute;inset:0;width:100%;height:100%;background:transparent;border:none;outline:none;opacity:0;cursor:pointer;appearance:none;z-index:1}
.capsule[data-multi="true"] select{pointer-events:none}
.cap-reset{position:absolute;right:6px;top:50%;transform:translateY(-50%);z-index:2;width:22px;height:22px;border-radius:9999px;background:rgba(0,0,0,.06);color:#111;border:none;cursor:pointer;display:none;line-height:22px;font-size:14px}
.cap-reset.show{display:inline-grid;place-items:center}
.section{margin-bottom:16px;background:#fff;border-radius:16px;box-shadow:0 4px 10px rgba(0,0,0,.06);overflow:hidden}
.section-head{background:var(--head-bg);color:var(--head-fg);padding:12px 16px;font-weight:700}
.block{padding:12px 16px}
.stats{display:grid;grid-template-columns:repeat(3,minmax(180px,1fr));gap:12px}
.stat-card{background:#fff;border:1px solid var(--line);border-radius:12px;padding:12px;box-shadow:0 2px 6px rgba(0,0,0,.04)}
.stat-label{font-size:12px;font-weight:700;color:#334155;margin:0 0 6px}
.stat-kpi{font-size:28px;font-weight:800;color:#222624;line-height:1}
.toolbar{display:flex;align-items:flex-start;gap:12px;padding:0 16px 12px;color:#555;font-size:13px;flex-wrap:wrap}
.pager{display:flex;flex-direction:column;gap:4px}
.pager-controls{display:flex;align-items:center;gap:12px}
.page-mini{font-size:6px;color:var(--gray);line-height:1}
.btn{background:var(--brand);color:#fff;border:none;border-radius:10px;padding:8px 12px;font-weight:600;cursor:pointer}
.btn[disabled]{opacity:.4;cursor:not-allowed}
.btn.danger{background:var(--danger)}
.jobsearch{position:relative;min-width:240px;flex:1 1 320px;max-width:520px}
.jobsearch .js-input{width:100%;border:1px solid var(--line);border-radius:9999px;padding:10px 38px 10px 36px;outline:none;background:#fff;box-shadow:0 1px 2px rgba(0,0,0,.04)}
.jobsearch .icon{position:absolute;left:12px;top:50%;transform:translateY(-50%);font-size:16px;opacity:.6}
.jobsearch .clear{position:absolute;right:8px;top:50%;transform:translateY(-50%);border:none;background:transparent;font-size:18px;opacity:.5;cursor:pointer;display:none}
.job-panel{position:absolute;left:0;right:0;top:calc(100% + 6px);z-index:60}
.table-wrap{position:relative;padding:0 16px 16px;max-height:65vh;background:#fff;overflow-x:auto;overflow-y:auto;-webkit-overflow-scrolling:touch;overscroll-behavior:contain;scrollbar-gutter:stable both-edges;cursor:grab}
.table-wrap:active{cursor:grabbing}
.table-empty{padding:24px;color:#64748b;font-size:13px}
table{width:max-content;max-width:none;border-collapse:separate;border-spacing:0;table-layout:auto}
thead th{position:sticky;top:var(--stickyOffset);z-index:20;background:var(--head-bg);color:var(--head-fg);border-top:3px solid var(--head-bg);border-bottom:2px solid #1a1d1b;text-align:left;padding:10px 8px;font-size:13px;white-space:nowrap}
tbody td{padding:8px;border-bottom:1px solid #eee;font-size:13px;vertical-align:middle;white-space:nowrap}
.col-name{width:var(--name-col-w);min-width:var(--name-col-w);max-width:var(--name-col-w)}
.cell-name{max-width:var(--name-col-w);overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
thead th.sticky-col,tbody td.sticky-col{position:sticky;left:0;background-clip:padding-box}
thead th.sticky-col{z-index:30;background:var(--head-bg)}
tbody td.sticky-col{z-index:25;background:#fff;box-shadow:4px 0 0 0 #fff,6px 0 8px -6px rgba(0,0,0,.18)}
@media (max-width:900px){.layout{grid-template-columns:220px 1fr}}
@media (max-width:640px){
  .header{padding:10px 12px}
  .title{font-size:18px}.subtitle{font-size:10px}
  .layout{grid-template-columns:1fr;padding:0 0 16px}
  .sidebar{display:none}
  .sidebar.open{display:block;position:fixed;left:0;right:0;top:0;bottom:0;border-radius:16px 16px 0 0;z-index:60;overflow:auto;background:#f6f8fa;box-shadow:0 -3px 18px rgba(0,0,0,.25)}
  .filters{gap:8px;padding:12px}.capsule{min-height:44px;padding:6px 30px 6px 10px}
  .filter-toggle{display:flex}
  .toolbar{gap:10px;padding:0 12px 10px;flex-direction:column}
  .jobsearch{width:100%;flex:1 1 100%}
  .btn{padding:7px 10px;border-radius:8px;font-size:12px}
  .table-wrap{padding:0 8px 8px;max-height:70vh}
  thead th{font-size:11px;padding:8px 6px} tbody td{font-size:11px;padding:6px}
}
.dash-wrap{display:none}
.view--dash .dash-wrap{display:block}
.view--dash .data-wrap{display:none}
.dash-filters-wrap{position:sticky;top:var(--stickyOffset);z-index:90;display:flex;justify-content:center;background:#f8faf7;border-bottom:1px solid var(--line)}
.dash-filters{display:flex;gap:10px;align-items:center;padding:10px 12px;flex-wrap:wrap;max-width:1100px;width:100%;justify-content:center}
.dfi{display:flex;align-items:center;gap:6px;background:#fff;border:1px solid var(--line);border-radius:12px;padding:6px 10px}
.dfi label{font-size:12px;font-weight:800;color:#475569}
.dfi select{font-size:12px;border:none;outline:none;background:transparent;padding:4px 0}
.dash-hamb{display:none;gap:8px;align-items:center;background:var(--brand);color:#fff;border:none;border-radius:12px;padding:8px 12px;font-weight:700;margin:10px auto}
.dash-icon{position:relative;width:18px;height:12px}
.dash-icon::before,.dash-icon::after,.dash-icon>span{content:"";position:absolute;left:0;right:0;height:2px;background:#fff;border-radius:2px}
.dash-icon::before{top:0}.dash-icon>span{top:5px}.dash-icon::after{bottom:0}
.dash-container{max-width:1200px;margin:16px auto;padding:0 12px}
.dash-section{background:#fff;border:1px solid var(--line);border-radius:16px;box-shadow:0 4px 10px rgba(0,0,0,.05);overflow:hidden;margin-bottom:16px}
.dash-head{background:var(--head-bg);color:var(--head-fg);padding:12px 16px;font-weight:800}
.dash-block{padding:14px 16px}
.dsum{display:grid;grid-template-columns:repeat(4,minmax(160px,1fr));gap:12px}
.dcard{border:1px solid var(--line);border-radius:12px;padding:12px;background:#fff;display:flex;flex-direction:column;gap:6px}
.dcard h4{margin:0;font-size:12px;color:#334155;font-weight:800}
.dcard .num{font-size:28px;font-weight:800;color:#111;display:flex;align-items:center;gap:8px}
.badge{display:inline-grid;place-items:center;width:28px;height:28px;border-radius:9999px;color:#fff;font-weight:800;font-size:16px}
.badge.male{background:var(--male)}
.badge.female{background:var(--female)}
.dbars{display:grid;grid-template-columns:1fr 1fr;gap:16px}
.dbarlist{border:1px solid var(--line);border-radius:12px;padding:12px;background:#fff}
.dbarlist h4{margin:0 0 10px;font-size:13px;color:#111;font-weight:800}
.bitem{display:flex;align-items:center;gap:10px;margin:8px 0}
.blabel{flex:0 0 220px;font-size:12px;color:#334155}
.btrack{flex:1;height:10px;background:#eef2f7;border-radius:9999px;overflow:hidden;position:relative}
.bfill{position:absolute;left:0;top:0;bottom:0;background:linear-gradient(90deg,#7fb77e,#3F704D)}
.bpct{flex:0 0 56px;text-align:right;font-size:12px;color:#111;font-weight:700}
@media (max-width:1000px){ .dsum{grid-template-columns:repeat(3,1fr)} }
@media (max-width:720px){ .dsum{grid-template-columns:repeat(2,1fr)} .dbars{grid-template-columns:1fr} }
@media (max-width:640px){
  .dash-filters{display:none}
  .dash-filters.open{display:flex}
  .dash-hamb{display:flex}
}
</style>
</head>
<body class="view--data">
<div id="loader" class="loading-screen" aria-live="polite" aria-busy="true">
  <div class="loading-logo">APPLICANT VALID</div>
  <div class="loading-bar" role="progressbar" aria-label="Memuat"></div>
  <div id="loader-sub" class="loading-sub">Menyiapkan aplikasi…</div>
</div>

<div id="auth" class="auth-screen" aria-labelledby="authTitle" aria-modal="true" role="dialog">
  <div class="auth-card">
    <h2 id="authTitle" class="auth-title">Masuk</h2>
    <p class="auth-sub">Gunakan kredensial yang diizinkan.</p>
    <form id="authForm" class="auth-form" autocomplete="off">
      <label for="authUser">Username</label>
      <input id="authUser" name="username" required minlength="3" autofocus>
      <label for="authPass">Password</label>
      <input id="authPass" name="password" type="password" required minlength="3">
      <div class="auth-actions">
        <button class="btn" type="submit">Login</button>
        <button id="authClearBtn" class="btn danger" type="button">Clear Session</button>
      </div>
      <div id="authError" class="auth-error">Username / password salah.</div>
      <div class="auth-hint">Hubungi Sourcing HO untuk mendapatkan login</div>
    </form>
  </div>
</div>

<header class="header">
  <div class="header-inner">
    <div>
      <h1 class="title">Applicant Valid</h1>
      <p class="subtitle">create &amp; develop by sourcing department</p>
    </div>
    <div style="display:flex;gap:8px;align-items:center">
      <a id="navData" href="#data" class="btn-ghost" aria-current="page">Data</a>
      <a id="navDash" href="#dashboard" class="btn-ghost">Dashboard</a>
      <div id="userBox" class="userbox">
        <span class="uname">👋 <b id="usernameLabel"></b></span>
        <button id="btnLogout" class="btn danger">Logout</button>
      </div>
    </div>
  </div>
</header>

<main class="app data-wrap">
  <div class="layout">
    <aside id="filterSidebar" class="sidebar" aria-label="Filter">
      <div class="sidebar-head">Filter</div>
      <div class="sidebar-body">
        <section id="filters" class="filters">
          <div class="capsule">
            <button class="cap-reset" data-for="f-year">✕</button>
            <label for="f-year">Tahun</label><span class="cap-value" id="val-year"></span>
            <select id="f-year"><option value="">Semua Tahun</option></select>
          </div>
          <div class="capsule" data-multi="true" data-key="month">
            <button class="cap-reset" data-for="multi-month">✕</button>
            <label>Bulan</label><span class="cap-value" id="val-month"></span><select aria-hidden="true"></select>
          </div>
          <div class="capsule" data-multi="true" data-key="day">
            <button class="cap-reset" data-for="multi-day">✕</button>
            <label>Tanggal</label><span class="cap-value" id="val-day"></span><select aria-hidden="true"></select>
          </div>
          <div class="capsule" data-multi="true" data-key="minat">
            <button class="cap-reset" data-for="multi-minat">✕</button>
            <label>Minat Posisi</label><span class="cap-value" id="val-minat"></span><select aria-hidden="true"></select>
          </div>
          <div class="capsule" data-multi="true" data-key="peng">
            <button class="cap-reset" data-for="multi-peng">✕</button>
            <label>Pengalaman Terakhir</label><span class="cap-value" id="val-peng"></span><select aria-hidden="true"></select>
          </div>
          <div class="capsule" data-multi="true" data-key="pend">
            <button class="cap-reset" data-for="multi-pend">✕</button>
            <label>Pendidikan Terakhir</label><span class="cap-value" id="val-pend"></span><select aria-hidden="true"></select>
          </div>
          <div class="capsule" data-multi="true" data-key="prov">
            <button class="cap-reset" data-for="multi-prov">✕</button>
            <label>Provinsi Minat</label><span class="cap-value" id="val-prov"></span><select aria-hidden="true"></select>
          </div>
          <div class="capsule" data-multi="true" data-key="kota">
            <button class="cap-reset" data-for="multi-kota">✕</button>
            <label>Kota Minat</label><span class="cap-value" id="val-kota"></span><select aria-hidden="true"></select>
          </div>
          <div class="capsule" data-multi="true" data-key="jobparent">
            <button class="cap-reset" data-for="multi-jobparent">✕</button>
            <label>Job Parent</label><span class="cap-value" id="val-jobparent"></span><select aria-hidden="true"></select>
          </div>
          <div class="capsule" data-multi="true" data-key="jobtype">
            <button class="cap-reset" data-for="multi-jobtype">✕</button>
            <label>Job Type</label><span class="cap-value" id="val-jobtype"></span><select aria-hidden="true"></select>
          </div>
          <div class="capsule" data-multi="true" data-key="cycle">
            <button class="cap-reset" data-for="multi-cycle">✕</button>
            <label>Cycle Hired</label><span class="cap-value" id="val-cycle"></span><select aria-hidden="true"></select>
          </div>
          <div class="capsule" data-multi="true" data-key="qualified">
            <button class="cap-reset" data-for="multi-qualified">✕</button>
            <label>Qualified</label><span class="cap-value" id="val-qualified"></span><select aria-hidden="true"></select>
          </div>
        </section>
      </div>
    </aside>

    <div class="content">
      <section class="section">
        <div class="section-head">Ringkasan Applicant Valid</div>
        <div class="block">
          <div class="stats">
            <div class="stat-card"><div class="stat-label">Total Applicant Valid</div><div id="stat-total" class="stat-kpi">0</div></div>
            <div class="stat-card"><div class="stat-label">Fresh Graduate</div><div id="stat-fresh" class="stat-kpi">0</div></div>
            <div class="stat-card"><div class="stat-label">Experienced</div><div id="stat-exp" class="stat-kpi">0</div></div>
          </div>
        </div>
      </section>

      <button id="filterToggle" class="filter-toggle" aria-controls="filterSidebar" aria-expanded="false" type="button">
        <span class="bars"><span></span></span> <span class="label">Filter</span>
      </button>

      <div class="toolbar">
        <div class="jobsearch" id="jobSearch">
          <span class="icon">🔎</span>
          <input id="jobInput" class="js-input" type="search" placeholder="Search by jobs…" autocomplete="off">
          <button id="jobClear" class="clear" title="Clear">✕</button>
          <div id="jobPanel" class="job-panel"></div>
        </div>
        <div class="pager">
          <div class="pager-controls">
            <button id="prev" class="btn">Prev</button>
            <button id="next" class="btn">Next</button>
          </div>
          <span id="pageMini" class="page-mini">1 of 1 halaman</span>
        </div>
        <button id="download" class="btn danger" title="Download Excel">⬇︎ Excel</button>
      </div>

      <section class="section">
        <div class="section-head">Table Data Applicant Valid</div>
        <div class="table-wrap" id="tableWrap">
          <div id="empty" class="table-empty" style="display:none">Tidak ada data untuk ditampilkan.</div>
          <table id="grid" style="display:none">
            <thead><tr id="thead-row"></tr></thead>
            <tbody id="tbody"></tbody>
          </table>
        </div>
      </section>
    </div>
  </div>
</main>

<main class="app dash-wrap">
  <div class="dash-filters-wrap">
    <div id="dashFilters" class="dash-filters" aria-label="Dashboard Filters">
      <div class="dfi">
        <label for="df-periode">Periode (AA)</label>
        <select id="df-periode"><option value="">Semua</option></select>
      </div>
      <div class="dfi">
        <label for="df-year">Tahun (A)</label>
        <select id="df-year"><option value="">Semua</option></select>
      </div>
    </div>
    <button id="dashHamb" class="dash-hamb" type="button" aria-expanded="false">
      <span class="dash-icon"><span></span></span><span>Filter</span>
    </button>
  </div>

  <div class="dash-container">
    <section class="dash-section">
      <div class="dash-head">Summary Applicant</div>
      <div class="dash-block">
        <div class="dsum">
          <div class="dcard"><h4>Total Applicant Valid</h4><div id="d-total" class="num">0</div></div>
          <div class="dcard"><h4>Total Qualified</h4><div id="d-qualified" class="num">0</div></div>
          <div class="dcard"><h4>Laki-laki</h4><div class="num"><span class="badge male">♂</span><span id="d-male">0</span></div></div>
          <div class="dcard"><h4>Perempuan</h4><div class="num"><span class="badge female">♀</span><span id="d-female">0</span></div></div>
        </div>

        <div class="dsum" style="margin-top:12px">
          <div class="dcard"><h4>Fresh Graduate</h4><div id="d-fresh" class="num">0</div></div>
          <div class="dcard"><h4>Experienced</h4><div id="d-exp" class="num">0</div></div>

        </div>

        <div class="dbarlist" style="margin-top:12px">
          <h4>Pendidikan (%)</h4>
          <div id="bar-edu"></div>
        </div>
      </div>
    </section>

    <section class="dash-section">
      <div class="dash-head">Demography</div>
      <div class="dash-block">
        <div class="dbars">
          <div class="dbarlist">
            <h4>Sumber Sourcing (%) — PSO / RO / SRO</h4>
            <div id="bar-sumber"></div>
          </div>
          <div class="dbarlist">
            <h4>Metode Sourcing (%) — Top 10</h4>
            <div id="bar-metode"></div>
          </div>
        </div>
        <div class="dbarlist" style="margin-top:16px">
          <h4>Provinsi (%)</h4>
          <div id="bar-prov"></div>
        </div>
      </div>
    </section>
  </div>
</main>

<script defer src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
<script defer src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<script>
/* ========= AUTH ========= */
const USERS=[{u:'sourcingho',p:'sourcingho',name:'Sourcing HO'},{u:'rizkia',p:'regional2',name:'Rizkia'},{u:'maulana',p:'regional3',name:'Maulana'},{u:'anindya',p:'regional1',name:'Anindya'}];
let DATA_LOADED=false;

function showAuth(){ document.getElementById('auth').style.display='grid'; const ld=document.getElementById('loader'); if(ld){ ld.style.display='none'; } }
function onLogin(skipBoot=false){
  const sess=JSON.parse(localStorage.getItem('pipeline_user')||'{}');
  const box=document.getElementById('userBox');
  const name=USERS.find(x=>x.u===sess.u)?.name || sess.u || 'User';
  document.getElementById('usernameLabel').textContent=name||''; box.style.display='flex';
  if(!skipBoot || !DATA_LOADED){ showLoader("Memuat data…"); boot(); }
  document.getElementById('auth').style.display='none';
}
function isValid(u,p){ return USERS.some(x=>x.u===u && x.p===p); }
document.getElementById('authForm').addEventListener('submit',(e)=>{
  e.preventDefault();
  const u=document.getElementById('authUser').value.trim();
  const p=document.getElementById('authPass').value;
  const err=document.getElementById('authError');
  if(isValid(u,p)){ localStorage.setItem('pipeline_user', JSON.stringify({u, t: Date.now()})); err.style.display='none'; onLogin(false); }
  else err.style.display='block';
});
document.getElementById('authClearBtn').addEventListener('click',()=>{ localStorage.removeItem('pipeline_user'); document.getElementById('authUser').value=''; document.getElementById('authPass').value=''; document.getElementById('authError').style.display='none'; });
document.getElementById('btnLogout').addEventListener('click',()=>{ localStorage.removeItem('pipeline_user'); location.reload(); });

/* ========= NAV ========= */
const navData=document.getElementById('navData');
const navDash=document.getElementById('navDash');
function setView(view){
  document.body.classList.toggle('view--data', view==='data');
  document.body.classList.toggle('view--dash', view==='dashboard');
  navData.setAttribute('aria-current', view==='data'?'page':null);
  navDash.setAttribute('aria-current', view==='dashboard'?'page':null);
  if(view==='dashboard' && DATA_LOADED){ Dash.requestRecalc(); }
}
function syncRoute(){ const hash=(location.hash||'').replace('#',''); setView(hash==='dashboard'?'dashboard':'data'); }
window.addEventListener('hashchange', syncRoute);

/* ========= DATA SOURCE ========= */
const SHEET_ID="1vCqN0EPXPuss2gYWMqJaQEpSOlSsvfm8x5WupPcPgKg";
const SHEETS_TRY=["Responses","Form Responses 1","Sheet1"];
const gvizCsv=(id, sheet)=>`https://docs.google.com/spreadsheets/d/${id}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(sheet)}`;

function wrapUrls(url){
  const clean = url.replace(/^https?:\/\//,'');
  return [
    url,
    `https://r.jina.ai/http://${clean}`,
    `https://r.jina.ai/http/${clean}`,
    `https://cors.isomorphic-git.org/${url}`
  ];
}

const FETCH_TIMEOUT_MS=15000;
const looksLikeHtml=t=>/<\s*html|<!doctype/i.test(t));

async function fetchWithTimeout(url,opt={},ms=FETCH_TIMEOUT_MS){
  const ctrl=new AbortController(); const id=setTimeout(()=>ctrl.abort(),ms);
  try{ return await fetch(url,{...opt,signal:ctrl.signal,cache:'no-store',redirect:'follow'});} finally{ clearTimeout(id); }
}

async function raceFetchCsv(url){
  console.log('[fetch] mencoba:', url);
  const candidates = wrapUrls(url).map(u=>{
    const full = u + (u.includes('?')?'&':'?') + '_=' + Date.now();
    return fetchWithTimeout(full).then(async r=>{
      if(!r.ok) throw new Error('HTTP '+r.status);
      const text=await r.text();
      if(!text || looksLikeHtml(text)) throw new Error('Bukan CSV / belum publik');
      return text.replace(/^\uFEFF/,'');
    });
  });
  try{
    const res = await Promise.any(candidates);
    console.log('[fetch] OK');
    return res;
  }catch(agg){
    console.error('[fetch] semua mirror gagal', agg);
    throw new Error('Gagal ambil CSV dari semua mirror. Pastikan Sheet dibuka publik atau "Publish to the web".');
  }
}

/* ========= CACHE CSV (5 menit) ========= */
const CACHE_KEY='csv_cache_v1';
const CACHE_TTL_MS=5*60*1000;
function readCsvCache(){
  try{ const j=JSON.parse(localStorage.getItem(CACHE_KEY)||'{}'); if(j.t && (Date.now()-j.t)<CACHE_TTL_MS && typeof j.text==='string') return j.text; }catch(_){}
  return null;
}
function writeCsvCache(text){ try{ localStorage.setItem(CACHE_KEY, JSON.stringify({t:Date.now(),text})); }catch(_){} }

/* ========= COMMON UTILS ========= */
const MONTH_NAMES=["Januari","Februari","Maret","April","Mei","Juni","Juli","Agustus","September","Oktober","November","Desember"];
const $=s=>document.querySelector(s);
const norm=s=>String(s ?? "").normalize('NFKD').replace(/[\u0300-\u036f]/g,'').replace(/[\u200B-\u200D\uFEFF\u00A0]/g,' ').toUpperCase().replace(/[^A-Z0-9 ]+/g,' ').replace(/\s+/g,' ').trim();
function parseDateParts(s){
  if(!s) return null; const d=new Date(s); if(!isNaN(d)) return {y:d.getFullYear(),m:d.getMonth()+1,d:d.getDate()};
  const m=String(s).match(/(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{2,4})/); if(m){let a=+m[1],b=+m[2],y=+m[3]; if(y<100) y+=2000; return (a>12)?{y,m:b,d:a}:{y,m:a,d:b};} return null;
}
function monthToOrder(s){ const x=String(s||'').trim().toLowerCase(); const idx=MONTH_NAMES.map(m=>m.toLowerCase()).indexOf(x); return idx>=0?idx:999; }

/* ===== Columns / Aliases ===== */
const TABLE_DISPLAY_COLUMNS=[
  "NAMA LENGKAP","TANGGAL LAHIR","NOMOR WA AKTIF","NOMOR HP AKTIF","JENIS KELAMIN",
  "PENGALAMAN KERJA TERAKHIR","DURASI PENGALAMAN KERJA",
  "MINAT POSISI KERJA PERTAMA","PENDIDIKAN TERAKHIR","KEPEMILIKAN KENDARAAN","ALAMAT DOMISILI","KECAMATAN","KELURAHAN",
  "PROVINSI MINAT PENEMPATAN","KOTA MINAT PENEMPATAN","UPLOAD CV",
  "SUMBER SOURCING","METODE SOURCING","MEDIA SOURCING","Job Parent","Job Type"
];
const EXPORT_COLUMNS=[
  "TIMESTAMP","EMAIL AKTIF","SUMBER INFORMASI LOWONGAN","NAMA LENGKAP","TANGGAL LAHIR","NOMOR WA AKTIF","NOMOR HP AKTIF","JENIS KELAMIN",
  "PENGALAMAN KERJA TERAKHIR","DURASI PENGALAMAN KERJA","MINAT POSISI KERJA PERTAMA","MINAT POSISI KERJA KEDUA","MINAT POSISI KERJA KETIGA",
  "PENDIDIKAN TERAKHIR","NAMA SEKOLAH / NAMA UNIVERITAS","JURUSAN","KEPEMILIKAN KENDARAAN","KEPEMILIKAN SIM AKTIF","ALAMAT DOMISILI","KECAMATAN","KELURAHAN",
  "PROVINSI MINAT PENEMPATAN","KOTA MINAT PENEMPATAN","UPLOAD CV",
  "QUALIFIED","SUMBER SOURCING","METODE SOURCING","MEDIA SOURCING","Job Parent","Job Type","NAMA REFERENSI","TEMPAT INFORMASI","Periode","CYCLE HIRED","USIA"
];
const ALIASES={
  "NAMA LENGKAP":"NAMA LENGKAP (SESUAI KTP)","TIMESTAMP":"Timestamp","UPLOAD CV":"UPLOAD CV / PORTOFOLIO",
  "Job Parent":{letter:"AI"},"Job Type":{letter:"AJ"},"CYCLE HIRED":{letter:"AB"},"QUALIFIED":{letter:"AE"},
  "PERIODE":{letter:"AA"}
};
const SYNONYMS={ /* (same expanded set as version sebelumnya, trimmed for brevity) */
  "NAMA LENGKAP":["NAMA LENGKAP (SESUAI KTP)","NAMA LENGKAP","NAMA","NAMA KANDIDAT","FULL NAME","NAMA LENGKAP SESUAI KTP"],
  "TANGGAL LAHIR":["TANGGAL LAHIR","TGL LAHIR","DATE OF BIRTH","DOB","TANGGAL/LAHIR","TTL","TEMPAT TANGGAL LAHIR"],
  "NOMOR WA AKTIF":["NOMOR WA AKTIF","NO WA AKTIF","NOMOR WHATSAPP AKTIF","WA AKTIF","WHATSAPP","NO WHATSAPP","NOMOR WA"],
  "NOMOR HP AKTIF":["NOMOR HP AKTIF","NO HP AKTIF","NOMOR HANDPHONE AKTIF","MOBILE","NO HP","NO TELEPON","TELEPON","PHONE"],
  "JENIS KELAMIN":["JENIS KELAMIN","GENDER","SEX"],
  "PENGALAMAN KERJA TERAKHIR":["PENGALAMAN KERJA TERAKHIR","PENGALAMAN TERAKHIR","PENGALAMAN KERJA","PENGALAMAN","STATUS PENGALAMAN","RIWAYAT PENGALAMAN"],
  "DURASI PENGALAMAN KERJA":["DURASI PENGALAMAN KERJA","DURASI PENGALAMAN","LAMA PENGALAMAN KERJA","DURASI PENGALAMAN (TAHUN)","LAMANYA PENGALAMAN"],
  "MINAT POSISI KERJA PERTAMA":["MINAT POSISI KERJA PERTAMA","MINAT POSISI PERTAMA","MINAT POSISI 1","POSISI MINAT 1","POSISI DIINGINKAN 1","JMINAT POSISI KERJA PERTAMA"],
  "PENDIDIKAN TERAKHIR":["PENDIDIKAN TERAKHIR","PEND TERAKHIR","TINGKAT PENDIDIKAN","EDUKASI TERAKHIR"],
  "KEPEMILIKAN KENDARAAN":["KEPEMILIKAN KENDARAAN","PUNYA KENDARAAN","KENDARAAN"],
  "ALAMAT DOMISILI":["ALAMAT DOMISILI","DOMISILI","ALAMAT","ALAMAT SEKARANG"],
  "KECAMATAN":["KECAMATAN"], "KELURAHAN":["KELURAHAN","DESA"],
  "PROVINSI MINAT PENEMPATAN":["PROVINSI MINAT PENEMPATAN","PROVINSI PENEMPATAN","PROVINSI","PROVINSI MINAT"],
  "KOTA MINAT PENEMPATAN":["KOTA MINAT PENEMPATAN","KAB/KOTA MINAT PENEMPATAN","KOTA MINAT","KABUPATEN/KOTA","KOTA","KABUPATEN"],
  "UPLOAD CV":["UPLOAD CV / PORTOFOLIO","UPLOAD CV","URL CV","LINK CV","CV","PORTOFOLIO","PORTFOLIO"],
  "SUMBER SOURCING":["SUMBER SOURCING","SUMBER","SOURCE","SUMBER INFORMASI LOWONGAN"],
  "METODE SOURCING":["METODE SOURCING","METODE","METHOD","METODE REKRUTMEN","METODE PENCARIAN"],
  "MEDIA SOURCING":["MEDIA SOURCING","MEDIA","CHANNEL","PLATFORM","MEDIA REKRUTMEN"],
  "Job Parent":["JOB PARENT","PARENT JOB","KATEGORI PEKERJAAN"],
  "Job Type":["JOB TYPE","TIPE PEKERJAAN","JENIS PEKERJAAN"],
  "QUALIFIED":["QUALIFIED","KUALIFIKASI","MEET REQUIREMENT","LOLOS SCREENING"],
  "CYCLE HIRED":["CYCLE HIRED","CYCLE","SIKLUS HIRED","SICLUS HIRED","CYCLE REKRUTMEN"],
  "TIMESTAMP":["Timestamp","WAKTU INPUT","WAKTU","TANGGAL INPUT"],
  "PERIODE":["Periode","PERIODE"]
};

const FILTER_MAP={
  ts:"TIMESTAMP", minat:"MINAT POSISI KERJA PERTAMA", minat2:"MINAT POSISI KERJA KEDUA", minat3:"MINAT POSISI KERJA KETIGA",
  peng:"PENGALAMAN KERJA TERAKHIR", pend:"PENDIDIKAN TERAKHIR", prov:"PROVINSI MINAT PENEMPATAN", kota:"KOTA MINAT PENEMPATAN",
  durasi:"DURASI PENGALAMAN KERJA", jobparent:{letter:"AI"}, jobtype:{letter:"AJ"}, cycle:{letter:"AB"}, qualified:{letter:"AE"}, periode:{letter:"AA"}
};

const PROV_ORDER=[/* … same as sebelumnya … */"Aceh (NAD)","Sumatera Utara","Sumatera Selatan","Sumatera Barat","Bengkulu","Riau","Kepulauan Riau","Jambi","Lampung","Bangka Belitung","Kalimantan Barat","Kalimantan Timur","Kalimantan Selatan","Kalimantan Tengah","Kalimantan Utara","Banten","DKI Jakarta","Jawa Barat","Jawa Tengah","DI Yogyakarta","Jawa Timur","Bali","Nusa Tenggara Timur (NTT)","Nusa Tenggara Barat (NTB)","Gorontalo","Sulawesi Barat","Sulawesi Tengah","Sulawesi Utara","Sulawesi Tenggara","Sulawesi Selatan","Maluku Utara","Maluku","Papua Barat","Papua","Papua Tengah","Papua Pegunungan","Papua Selatan","Papua Barat Daya"];
const PROV_ALIASES={"ACEH":"Aceh (NAD)","NANGGROE ACEH DARUSSALAM":"Aceh (NAD)","NAD":"Aceh (NAD)","KEPULAUAN RIAU":"Kepulauan Riau","KEPRI":"Kepulauan Riau","D I YOGYAKARTA":"DI Yogyakarta","D.I. YOGYAKARTA":"DI Yogyakarta","DAERAH ISTIMEWA YOGYAKARTA":"DI Yogyakarta","NUSA TENGGARA BARAT":"Nusa Tenggara Barat (NTB)","NTB":"Nusa Tenggara Barat (NTB)","NUSA TENGGARA TIMUR":"Nusa Tenggara Timur (NTT)","NTT":"Nusa Tenggara Timur (NTT)","DKI JAKARTA":"DKI Jakarta","JAKARTA":"DKI Jakarta","BANGKA BELITUNG":"Bangka Belitung","BABEL":"Bangka Belitung","PAPUA BARAT DAYA":"Papua Barat Daya","PAPUA SELATAN":"Papua Selatan","PAPUA PEGUNUNGAN":"Papua Pegunungan","PAPUA TENGAH":"Papua Tengah"};
function canonicalProv(s){ if(!s) return ""; const up=String(s).trim().toUpperCase(); if(PROV_ALIASES[up]) return PROV_ALIASES[up]; const exact=PROV_ORDER.find(p=>p.toUpperCase()===up); if(exact) return exact; if(up.includes("YOGYA")) return "DI Yogyakarta"; if(up.includes("RIAU")&&up.includes("KEP")) return "Kepulauan Riau"; if(up==="ACEH") return "Aceh (NAD)"; return s.trim(); }

let HEADERS=[], NAME_MAP={}, ROWS=[], page=0, COL_MAP={};
let OPTIONS={month:[],day:[],minat:[],peng:[],pend:[],prov:[],kota:[],jobparent:[],jobtype:[],cycle:[],qualified:[]};
let MULTI={month:new Set(),day:new Set(),minat:new Set(),peng:new Set(),pend:new Set(),prov:new Set(),kota:new Set(),jobparent:new Set(),jobtype:new Set(),cycle:new Set(),qualified:new Set(),searchJobs:new Set()};
let JOB_OPTS=[];

function letterToIndex(letter){ const s=String(letter).toUpperCase().trim(); let n=0; for(let i=0;i<s.length;i++){ n=n*26+(s.charCodeAt(i)-64); } return n-1; }
function headerByLetter(letter){ const idx=letterToIndex(letter); return HEADERS[idx]||null; }

function findHeader(label){
  if(!label) return null;
  const base=[label]; const alias=ALIASES[label];
  if(typeof alias==='string') base.push(alias);
  if(SYNONYMS[label]) base.push(...SYNONYMS[label]);
  for(const cand of base){ const hit=NAME_MAP[norm(cand)]; if(hit) return hit; }
  const wantTokens=new Set(norm(base[0]).split(' ').filter(Boolean));
  let best=null,bestScore=0;
  for(const h of HEADERS){
    const H=norm(h), haveTokens=new Set(H.split(' ').filter(Boolean));
    const inter=[...wantTokens].filter(t=>haveTokens.has(t)).length;
    const uni=new Set([...wantTokens,...haveTokens]).size||1;
    let score=inter/uni;
    if(H.includes(norm(label))||norm(label).includes(H)) score+=0.3;
    if(score>bestScore){ best=h; bestScore=score; }
  }
  return bestScore>=0.4?best:null;
}
function setStickyOffset(){ const h=document.querySelector('.header'); const px=h?Math.round(h.getBoundingClientRect().height):64; document.documentElement.style.setProperty('--stickyOffset', px+'px'); }

function buildColMap(){
  COL_MAP={};
  for(const label of TABLE_DISPLAY_COLUMNS){
    const alias=ALIASES[label];
    if(alias && typeof alias==='object' && alias.letter){
      const h=headerByLetter(alias.letter); if(h){ COL_MAP[label]=h; continue; }
    }
    let hit=findHeader(label);
    if(hit){ COL_MAP[label]=hit; continue; }
    const tokens=norm(label).split(' ').filter(Boolean);
    const cand=HEADERS.find(h=>tokens.some(t=>norm(h).includes(t)));
    if(cand) COL_MAP[label]=cand;
  }
  try{ const summary=Object.fromEntries(TABLE_DISPLAY_COLUMNS.map(k=>[k, COL_MAP[k]||'(N/A)'])); console.table(summary); }catch(_){}
}
function buildColumns(){ const row=document.getElementById('thead-row'); row.innerHTML=""; TABLE_DISPLAY_COLUMNS.forEach((label,idx)=>{ const th=document.createElement("th"); th.textContent=label; if(idx===0) th.classList.add('sticky-col','col-name'); row.appendChild(th); }); }
function fillSelect(sel,values,placeholder,disable=false){ sel.innerHTML=""; const o0=document.createElement("option");o0.value="";o0.textContent=placeholder;sel.appendChild(o0); values.forEach(v=>{const o=document.createElement("option");o.value=v.value;o.textContent=v.label??v.value;sel.appendChild(o);}); sel.disabled=disable; }
function buildYearOptions(){
  const yearsSet=new Set();
  ROWS.forEach(r=>{
    const ts = get(r,"TIMESTAMP") || get(r,{letter:'A'});
    const d = parseDateParts(ts);
    if(d && d.y) yearsSet.add(d.y);
    else{
      const per = String(get(r,{letter:'AA'})||'').match(/(20\d{2}|19\d{2})/);
      if(per) yearsSet.add(+per[1]);
    }
  });
  const years=[...yearsSet].sort((a,b)=>a-b).map(y=>({value:String(y),label:String(y)}));
  fillSelect(document.getElementById("f-year"), years, "Semua Tahun", years.length===0);
}
const selectedYear=()=> parseInt(document.getElementById("f-year").value||"0",10) || null;

function getByLetter(row,letter){ const h=headerByLetter(letter); return h ? (row[h]??"") : ""; }
function get(row,label){
  const alias=ALIASES[label];
  if(alias && typeof alias==='object' && alias.letter){ const via=getByLetter(row,alias.letter); if(via!=="" && via!=null) return via; }
  const key=COL_MAP[label] || findHeader(label) || (typeof alias==='string'?findHeader(alias):null) || label;
  return row[key] ?? "";
}
function val(row,spec){ if(typeof spec==='string') return get(row,spec); if(spec && typeof spec==='object' && spec.letter) return getByLetter(row,spec.letter); return ""; }

function rebuildMonthDayOptions(){
  const y=selectedYear();
  const rowsY=ROWS.filter(r=>{
    const ts=get(r,"TIMESTAMP")||get(r,{letter:'A'}); const P=parseDateParts(ts);
    const yearFromPeriode = (String(get(r,{letter:'AA'})||'').match(/(20\d{2}|19\d{2})/)||[])[1];
    const yy = P?.y ?? (yearFromPeriode?+yearFromPeriode:null);
    return (!y || (yy===y));
  });
  const months=[...new Set( rowsY.map(r=>parseDateParts(get(r,"TIMESTAMP")||get(r,{letter:'A'}))?.m ))].filter(Boolean).sort((a,b)=>a-b);
  OPTIONS.month=months; MULTI.month=new Set([...MULTI.month].filter(v=>OPTIONS.month.includes(v)));
  const rowsYM=rowsY.filter(r=>{const P=parseDateParts(get(r,"TIMESTAMP")||get(r,{letter:'A'})); return MULTI.month.size?MULTI.month.has(P?.m):true;});
  const days=[...new Set( rowsYM.map(r=>parseDateParts(get(r,"TIMESTAMP")||get(r,{letter:'A'}))?.d ) )].filter(Boolean).sort((a,b)=>a-b);
  OPTIONS.day=days; MULTI.day=new Set([...MULTI.day].filter(v=>OPTIONS.day.includes(v)));
}
function subsetByDate(){
  const y=selectedYear(),hasM=MULTI.month.size>0,hasD=MULTI.day.size>0, use=!!(y||hasM||hasD);
  return ROWS.filter(r=>{
    const ts=get(r,"TIMESTAMP")||get(r,{letter:'A'}); const P=parseDateParts(ts);
    let yy=P?.y;
    if(!yy){ const m=String(get(r,{letter:'AA'})||'').match(/(20\d{2}|19\d{2})/); if(m) yy=+m[1]; }
    if(!use) return true;
    if(y && yy!==y) return false;
    if(hasM && !(P&&MULTI.month.has(P.m))) return false;
    if(hasD && !(P&&MULTI.day.has(P.d))) return false;
    return true;
  });
}
function rebuildOtherFiltersFromDate(){
  let base=subsetByDate(); if(MULTI.minat.size){base=base.filter(r=> MULTI.minat.has(String(val(r,FILTER_MAP.minat)||"").trim()));}
  const sets={minat:new Set(),peng:new Set(),pend:new Set(),prov:new Set(),kota:new Set(),jobparent:new Set(),jobtype:new Set(),cycle:new Set(),qualified:new Set()};
  subsetByDate().forEach(r=> sets.minat.add(String(val(r,FILTER_MAP.minat)||"").trim()) );
  base.forEach(r=>{
    sets.peng.add(String(val(r,FILTER_MAP.peng)||"").trim());
    sets.pend.add(String(val(r,FILTER_MAP.pend)||"").trim());
    sets.prov.add(String(val(r,FILTER_MAP.prov)||"").trim());
    sets.kota.add(String(val(r,FILTER_MAP.kota)||"").trim());
    sets.jobparent.add(String(val(r,FILTER_MAP.jobparent)||"").trim());
    sets.jobtype.add(String(val(r,FILTER_MAP.jobtype)||"").trim());
    sets.cycle.add(String(val(r,FILTER_MAP.cycle)||"").trim());
    sets.qualified.add(String(val(r,FILTER_MAP.qualified)||"").trim());
  });
  OPTIONS.minat=[...sets.minat].filter(Boolean).sort();
  for(const k of ['peng','pend','prov','kota','jobparent','jobtype','cycle','qualified']){
    OPTIONS[k]=[...sets[k]].filter(Boolean).sort();
    MULTI[k]=new Set([...MULTI[k]].filter(v=>OPTIONS[k].includes(v)));
  }
  rebuildJobOptions();
}
function rebuildJobOptions(){
  const rows=subsetByDate(); const set=new Set();
  rows.forEach(r=>{ ["MINAT POSISI KERJA PERTAMA","MINAT POSISI KERJA KEDUA","MINAT POSISI KERJA KETIGA"].forEach(col=>{ const v=String(get(r,col)||"").trim(); if(v) set.add(v); }); });
  JOB_OPTS=[...set].sort((a,b)=>String(a).localeCompare(String(b)));
}
function filteredRows(){
  let base=subsetByDate(); const has=k=>MULTI[k]&&MULTI[k].size>0;
  if(has('minat')) base=base.filter(r=> MULTI.minat.has(String(val(r,FILTER_MAP.minat)||"").trim()));
  if(has('peng'))  base=base.filter(r=> MULTI.peng.has(String(val(r,FILTER_MAP.peng)||"").trim()));
  if(has('pend'))  base=base.filter(r=> MULTI.pend.has(String(val(r,FILTER_MAP.pend)||"").trim()));
  if(has('prov'))  base=base.filter(r=> MULTI.prov.has(String(val(r,FILTER_MAP.prov)||"").trim()));
  if(has('kota'))  base=base.filter(r=> MULTI.kota.has(String(val(r,FILTER_MAP.kota)||"").trim()));
  if(has('jobparent')) base=base.filter(r=> MULTI.jobparent.has(String(val(r,FILTER_MAP.jobparent)||"").trim()));
  if(has('jobtype'))   base=base.filter(r=> MULTI.jobtype.has(String(val(r,FILTER_MAP.jobtype)||"").trim()));
  if(has('cycle'))     base=base.filter(r=> MULTI.cycle.has(String(val(r,FILTER_MAP.cycle)||"").trim()));
  if(has('qualified')) base=base.filter(r=> MULTI.qualified.has(String(val(r,FILTER_MAP.qualified)||"").trim()));
  if(has('searchJobs')){
    const wanted=new Set([...MULTI.searchJobs].map(String));
    base=base.filter(r=>
      wanted.has(String(val(r,FILTER_MAP.minat)||"").trim()) ||
      wanted.has(String(val(r,FILTER_MAP.minat2)||"").trim()) ||
      wanted.has(String(val(r,FILTER_MAP.minat3)||"").trim())
    );
  }
  return base;
}
function isFreshGraduate_row(r){
  const dur=String(val(r,FILTER_MAP.durasi)).toLowerCase(), peng=String(val(r,FILTER_MAP.peng)).toLowerCase(), t=dur+" "+peng;
  if(/fresh\s*graduate|freshgrad|fresh\b/.test(t)) return true;
  if(/belum.*pengalaman|tanpa.*pengalaman|no.*experience/.test(t)) return true;
  const m=dur.match(/(\d+(?:[.,]\d+)?)/); if(m){const v=parseFloat(m[1].replace(',','.')); if(v===0) return true; if(v>0) return false;}
  if(!dur.trim() && (!peng.trim() || /-+|tidak|belum/.test(peng))) return true;
  return false;
}
function renderStats(rows){
  const total=rows.length; let fresh=0; rows.forEach(r=>{if(isFreshGraduate_row(r)) fresh++;});
  document.getElementById("stat-total").textContent=total.toLocaleString('id-ID');
  document.getElementById("stat-fresh").textContent=fresh.toLocaleString('id-ID');
  document.getElementById("stat-exp").textContent=(total-fresh).toLocaleString('id-ID');
}
function updatePageMini(total){const pages=Math.max(1,Math.ceil(total/100)); document.getElementById("pageMini").textContent=`${page+1} of ${pages} halaman`;}
function showTable(show){ document.getElementById("grid").style.display = show?'table':'none'; document.getElementById("empty").style.display = show?'none':'block'; }
function renderTable(rows){
  showTable(rows.length>0); if(!rows.length){ document.getElementById("tbody").innerHTML=''; updatePageMini(1); return; }
  const PAGE_SIZE=100, start=page*PAGE_SIZE, slice=rows.slice(start,start+PAGE_SIZE); const tbody=document.getElementById("tbody"); tbody.innerHTML="";
  slice.forEach(r=>{
    const tr=document.createElement("tr");
    TABLE_DISPLAY_COLUMNS.forEach((label,idx)=>{
      const td=document.createElement("td");
      const v=get(r,label) || (typeof ALIASES[label]==='object' && ALIASES[label].letter ? getByLetter(r, ALIASES[label].letter) : "") || get(r, ALIASES[label]||label);
      if(idx===0) td.classList.add('sticky-col','cell-name','col-name');
      if(/UPLOAD|CV/i.test(label)){
        const s=String(v||""); td.innerHTML=s.startsWith("http")?`<a href="${s}" target="_blank" rel="noopener">Link CV</a>`:s;
      } else td.textContent=v;
      tr.appendChild(td);
    });
    tbody.appendChild(tr);
  });
  document.getElementById("prev").disabled=page<=0; document.getElementById("next").disabled=(start+PAGE_SIZE)>=rows.length; updatePageMini(rows.length);
}
function recalcData(reset=true){const rows=filteredRows(); if(reset) page=0; renderStats(rows); buildColumns(); renderTable(rows);}

/* ===== DASHBOARD ===== */
const Dash=(()=>{ /* identical to previous (omitted for brevity) */ 
  const selPeriode=document.getElementById('df-periode'), selYear=document.getElementById('df-year'), hambBtn=document.getElementById('dashHamb'), bar=document.getElementById('dashFilters');
  hambBtn.addEventListener('click',()=>{ const open=bar.classList.toggle('open'); hambBtn.setAttribute('aria-expanded', open?'true':'false'); });
  const setNum=(id,val)=> document.getElementById(id).textContent = Number(val||0).toLocaleString('id-ID');
  function renderBars(containerId,pairs){ const cont=document.getElementById(containerId); cont.innerHTML=''; pairs.forEach(([label,pct])=>{ const row=document.createElement('div'); row.className='bitem'; const bl=document.createElement('div'); bl.className='blabel'; bl.textContent=(label||'(Kosong)'); const track=document.createElement('div'); track.className='btrack'; const fill=document.createElement('div'); fill.className='bfill'; fill.style.width=(isFinite(pct)?pct:0)+'%'; const bp=document.createElement('div'); bp.className='bpct'; bp.textContent=isNaN(pct)?'0%':(Math.round(pct)+'%'); track.appendChild(fill); row.appendChild(bl); row.appendChild(track); row.appendChild(bp); cont.appendChild(row); });}
  function detectYear(r){ const ts=get(r,"TIMESTAMP")||get(r,{letter:'A'}); const d=ts?parseDateParts(ts):null; if(d&&d.y) return d.y; const per=String(get(r,{letter:'AA'})||get(r,"PERIODE")||''); const m=per.match(/(20\d{2}|19\d{2})/); return m?+m[1]:null; }
  function applyFilters(rows){ const p=selPeriode.value.trim(); const y=parseInt(selYear.value||''); return rows.filter(r=>{ const per=String(get(r,{letter:'AA'})||get(r,"PERIODE")).trim(); const passP=p?(per===p):true; const yy=detectYear(r); const passY=y?(yy===y):true; return passP&&passY; });}
  function dedupeRows(rows){ const seen=new Set(), out=[]; const keyFor=r=>{ const nama=String(get(r,"NAMA LENGKAP")).trim().toUpperCase(); const wa=String(get(r,"NOMOR WA AKTIF")).replace(/\D+/g,''); const hp=String(get(r,"NOMOR HP AKTIF")).replace(/\D+/g,''); const min1=String(get(r,"MINAT POSISI KERJA PERTAMA")).trim().toUpperCase(); return [nama,wa,hp,min1].join('|'); }; for(const r of rows){ const k=keyFor(r); if(!seen.has(k)){ seen.add(k); out.push(r); } } return out; }
  function countBy(rows,getter){ const map=new Map(); rows.forEach(r=>{ const k=(getter(r)||'').toString().trim(); if(!k) return; map.set(k,(map.get(k)||0)+1); }); return map; }
  function sumMap(map){ let n=0; for(const v of map.values()) n+=v; return n; }
  function toPctPairs(map,{limitTop=null,otherLabel='Lainnya'}={}){ const total=sumMap(map)||1; const arr=[...map.entries()].sort((a,b)=>b[1]-a[1]).map(([k,v])=>[k, v*100/total]); if(limitTop && arr.length>limitTop){ const top=arr.slice(0,limitTop); const restPct=arr.slice(limitTop).reduce((s,[_k,p])=>s+p,0); return [...top,[otherLabel,restPct]]; } return arr; }
  function recalc(){ const base=applyFilters(ROWS); const dedup=dedupeRows(base); setNum('d-total',dedup.length);
    const qCnt=dedup.filter(r=>{ const v=String(get(r,{letter:'AE'})||get(r,"QUALIFIED")).trim().toUpperCase(); if(!v) return false; return !/^NO|TIDAK|0|FALSE$/i.test(v); }).length; setNum('d-qualified',qCnt);
    let male=0,female=0; dedup.forEach(r=>{ const g=String(get(r,"JENIS KELAMIN")).toUpperCase(); if(/L(?!\w)|PRIA|LAKI/.test(g)) male++; else if(/P(?!\w)|WANITA|PEREMPUAN/.test(g)) female++; }); setNum('d-male',male); setNum('d-female',female);
    let fresh=0; dedup.forEach(r=>{ const dur=String(get(r,"DURASI PENGALAMAN KERJA")).toLowerCase(); const peng=String(get(r,"PENGALAMAN KERJA TERAKHIR")).toLowerCase(); const t=dur+" "+peng; let fg=false; if(/fresh\s*graduate|freshgrad|fresh\b/.test(t)) fg=true; if(/belum.*pengalaman|tanpa.*pengalaman|no.*experience/.test(t)) fg=true; const m=dur.match(/(\d+(?:[.,]\d+)?)/); if(m){ const v=parseFloat(m[1].replace(',','.')); if(v===0) fg=true; } if(!dur.trim() && (!peng.trim()||/-+|tidak|belum/.test(peng))) fg=true; if(fg) fresh++; }); setNum('d-fresh',fresh); setNum('d-exp',dedup.length-fresh);
    const eduMapRaw=countBy(dedup,r=>String(get(r,"PENDIDIKAN TERAKHIR")).toUpperCase()); const eduMap=new Map([["SMA/SMK",0],["D1",0],["D2",0],["D3",0],["D4",0],["S1",0],["S2",0],["S3",0]]);
    for(const [k,v] of eduMapRaw.entries()){ const kk=k.replace(/\./g,'').trim(); if(/SMA|SMK|MA\b/.test(kk)) eduMap.set("SMA/SMK",(eduMap.get("SMA/SMK")||0)+v); else if(/\bD1\b/.test(kk)) eduMap.set("D1",(eduMap.get("D1")||0)+v); else if(/\bD2\b/.test(kk)) eduMap.set("D2",(eduMap.get("D2")||0)+v); else if(/\bD3\b/.test(kk)) eduMap.set("D3",(eduMap.get("D3")||0)+v); else if(/\bD4\b|SARJANA TERAPAN/.test(kk)) eduMap.set("D4",(eduMap.get("D4")||0)+v); else if(/\bS1\b|SARJANA(?! TERAPAN)/.test(kk)) eduMap.set("S1",(eduMap.get("S1")||0)+v); else if(/\bS2\b|MAGISTER/.test(kk)) eduMap.set("S2",(eduMap.get("S2")||0)+v); else if(/\bS3\b|DOKTOR/.test(kk)) eduMap.set("S3",(eduMap.get("S3")||0)+v); }
    renderBars('bar-edu',toPctPairs(eduMap));
    const sumberMapRaw=countBy(dedup,r=> get(r,"SUMBER SOURCING")||get(r,"SUMBER")||get(r,"SOURCE")); const sumberNorm=new Map([["PSO",0],["RO",0],["SRO",0]]); for(const [k,v] of sumberMapRaw.entries()){ const kk=String(k).toUpperCase(); if(/PSO/.test(kk)) sumberNorm.set("PSO",(sumberNorm.get("PSO")||0)+v); else if(/\bRO\b/.test(kk)) sumberNorm.set("RO",(sumberNorm.get("RO")||0)+v); else if(/SRO/.test(kk)) sumberNorm.set("SRO",(sumberNorm.get("SRO")||0)+v); else sumberNorm.set(k,(sumberNorm.get(k)||0)+v); } renderBars('bar-sumber',toPctPairs(sumberNorm));
    const metodeRaw=countBy(dedup,r=> get(r,"METODE SOURCING")||get(r,"METODE")); renderBars('bar-metode',toPctPairs(metodeRaw,{limitTop:10,otherLabel:"Lainnya"}));
    const provCounts=new Map(PROV_ORDER.map(p=>[p,0])); dedup.forEach(r=>{ const raw=get(r,"PROVINSI MINAT PENEMPATAN")||get(r,"PROVINSI"); const canon=canonicalProv(raw); if(provCounts.has(canon)) provCounts.set(canon,(provCounts.get(canon)||0)+1); }); const totalProv=[...provCounts.values()].reduce((s,v)=>s+v,0)||1; const provPairs=PROV_ORDER.map(p=>[p,(provCounts.get(p)||0)*100/totalProv]); renderBars('bar-prov',provPairs); }
  let dashRAF=0; function requestRecalc(){ cancelAnimationFrame(dashRAF); dashRAF=requestAnimationFrame(recalc); }
  function buildFilters(){ const perSet=new Set(); ROWS.forEach(r=>{ const v=String(get(r,{letter:'AA'})||get(r,"PERIODE")).trim(); if(v) perSet.add(v); }); const perArr=[...perSet].sort((a,b)=> monthToOrder(a)-monthToOrder(b)||String(a).localeCompare(String(b)); document.getElementById('df-periode').innerHTML='<option value="">Semua</option>'+perArr.map(p=>`<option>${p}</option>`).join(''); const yearSet=new Set(); ROWS.forEach(r=>{ const y=detectYear(r); if(y) yearSet.add(y); }); const years=[...yearSet].sort((a,b)=>a-b); document.getElementById('df-year').innerHTML='<option value="">Semua</option>'+years.map(y=>`<option value="${y}">${y}</option>`).join(''); document.getElementById('df-periode').addEventListener('change',requestRecalc); document.getElementById('df-year').addEventListener('change',requestRecalc);}
  return { buildFilters, requestRecalc };
})();

/* ===== BOOT ===== */
function hideLoader(){const el=document.getElementById('loader');if(!el) return;el.style.opacity="0";el.style.transition="opacity .25s ease";setTimeout(()=>{el.style.display="none";document.body.classList.add("ready");},250)}
function showLoader(msg){const el=document.getElementById('loader'); if(!el) return; document.body.classList.remove('ready'); el.style.display='flex'; el.style.opacity='1'; document.getElementById('loader-sub').textContent=msg||'Memproses…';}
function showLoaderError(msg){document.getElementById('loader-sub').textContent=msg||"Gagal memuat data."}

async function parseCsvToRows(csvText){
  return new Promise((resolve,reject)=>{
    Papa.parse(csvText.replace(/^\uFEFF/,''),{
      header:true, skipEmptyLines:'greedy', worker:true, fastMode:true,
      complete:(parsed)=>{
        try{
          const headers=(parsed.meta.fields||[]).map(h=>String(h||'').replace(/[\u200B-\u200D\uFEFF\u00A0]/g,' ').replace(/\s+/g,' ').trim());
          const rows=(parsed.data||[]).map(r=>{const o={}; headers.forEach(h=>o[h]=r[h]); return o;});
          const MAP={}; headers.forEach(h=>MAP[norm(h)]=h);
          if(!headers.length) throw new Error('Header tidak terbaca (cek akses publik & nama sheet).');
          resolve({headers,rows,MAP});
        }catch(e){reject(e);}
      },
      error:reject
    });
  });
}

async function loadData(){
  const cached=readCsvCache();
  if(cached){
    const parsed=await parseCsvToRows(cached);
    if(parsed.rows.length) return { fields: parsed.headers, NAME_MAP: parsed.MAP, rows: parsed.rows, via:'cache' };
  }
  let lastErr=null;
  for(const name of SHEETS_TRY){
    try{
      showLoader(`Mengambil data dari sheet "${name}"…`);
      const url=gvizCsv(SHEET_ID,name);
      const text=await raceFetchCsv(url);
      writeCsvCache(text);
      const parsed=await parseCsvToRows(text);
      if(!parsed.rows.length){ lastErr=new Error('CSV kosong'); continue; }
      return { fields: parsed.headers, NAME_MAP: parsed.MAP, rows: parsed.rows, via:`gviz:${name}` };
    }catch(e){
      console.warn('Gagal sheet', name, e);
      lastErr=e;
    }
  }
  throw new Error(`Gagal muat: ${lastErr ? lastErr.message : 'unknown'}`);
}
function applyData(result){
  HEADERS=result.fields; NAME_MAP=result.NAME_MAP; ROWS=result.rows;
  page=0; buildColMap(); buildYearOptions(); rebuildMonthDayOptions(); rebuildOtherFiltersFromDate(); recalcData();
  Dash.buildFilters(); Dash.requestRecalc();
  setStickyOffset();
}
async function boot(){
  try{
    const sess=localStorage.getItem('pipeline_user');
    if(!sess){ showAuth(); hideLoader(); return; }
    const result=await loadData();
    if(!result.rows.length){ showLoaderError("Tidak ada data pada sheet/CSV."); hideLoader(); DATA_LOADED=true; return; }
    applyData(result); hideLoader(); DATA_LOADED=true;
  }catch(err){
    console.error(err);
    showLoaderError(`Gagal memuat data: ${String(err.message||err)}. Pastikan Google Sheet share "Anyone with the link" & "Publish to the web".`);
    hideLoader(); DATA_LOADED=false; showAuth();
  }
}

/* ===== DOWNLOAD ===== */
document.getElementById('download').addEventListener('click',()=>{
  const rows=filteredRows();
  const data=rows.map(r=>{
    const o={};
    EXPORT_COLUMNS.forEach(col=>{
      if(col==="USIA"){
        const fromSheet=get(r,"USIA");
        o[col]=fromSheet || (function computeAge(dob){ const p=parseDateParts(dob); if(!p) return ""; const t=new Date(); let age=t.getFullYear()-p.y; const mm=t.getMonth()+1-p.m; const dd=t.getDate()-p.d; if(mm<0||(mm===0&&dd<0)) age--; return (age>=0&&age<130)?String(age):""; })(get(r,"TANGGAL LAHIR"));
      } else {
        const alias=ALIASES[col];
        if(alias && typeof alias==='object' && alias.letter){ o[col]=getByLetter(r,alias.letter) ?? ""; }
        else { o[col]=get(r,col)??""; }
      }
    });
    return o;
  });
  const ws=XLSX.utils.json_to_sheet(data); const wb=XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb,ws,'Filtered');
  const pad=n=>String(n).padStart(2,'0'); const t=new Date();
  XLSX.writeFile(wb, `applicant_valid_${t.getFullYear()}${pad(t.getMonth()+1)}${pad(t.getDate())}_${pad(t.getHours())}${pad(t.getMinutes())}.xlsx`);
});

/* ===== INIT ===== */
(function init(){
  syncRoute();
  setStickyOffset();
  window.addEventListener('resize', setStickyOffset);

  const sidebarEl=document.getElementById('filterSidebar'); const toggleBtn=document.getElementById('filterToggle');
  if(toggleBtn&&sidebarEl){ toggleBtn.addEventListener('click',()=>{ const open=sidebarEl.classList.toggle('open'); toggleBtn.setAttribute('aria-expanded', open?'true':'false'); }); }
  document.getElementById('prev').addEventListener('click',()=>{ if(page>0){ page--; recalcData(false); } });
  document.getElementById('next').addEventListener('click',()=>{ page++; recalcData(false); });

  const sess = localStorage.getItem('pipeline_user');
  if(sess){
    const parsed=JSON.parse(sess||'{}');
    const name=USERS.find(x=>x.u===parsed.u)?.name || parsed.u || 'User';
    document.getElementById('usernameLabel').textContent=name||''; document.getElementById('userBox').style.display='flex';
    showLoader("Memuat data…");
    boot();                // ✅ hanya SEKALI
  }else{
    showAuth();
    hideLoader();
  }
})();
</script>
</body>
</html>
